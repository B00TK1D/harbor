#!/bin/bash

ACTION="help"
if [ -n "$1" ]; then
    if [ "$1" == "up" ]; then
        ACTION="up"
      elif [ "$1" == "down" ]; then
        ACTION="down"
    fi
fi

if [ "$ACTION" == "help" ]; then
    echo "Usage: harbor <up|down> [replica_count] [compose_path] [harbor_name]"
    exit 0
fi

if [ -n "$2" ]; then
    REPLICA_COUNT=$2
else
    REPLICA_COUNT=3
fi

if [ -n "$3" ]; then
  HARBOR_PATH=$(realpath "$3")
else
    HARBOR_PATH=$(pwd)
fi

if [ -n "$4" ]; then
    HARBOR_NAME="$4"
else
    HARBOR_NAME=$(basename ${HARBOR_PATH} | tr ' ' '_')
fi

HARBOR_HASH=$(echo -n "${HARBOR_PATH}" | md5sum | cut -c1-8)

pushd ${HARBOR_PATH} >/dev/null
docker compose config >/dev/null || { echo "Error: Invalid docker-compose file in ${HARBOR_PATH}"; exit 1; }

# Find the first unused 10.11.X.0/24 subnet across all docker networks
# List all docker container IPs and find used subnets
USED_SUBNETS=$(docker network ls -q | xargs -I {} docker network inspect {} --format '{{range .Containers}}{{.IPv4Address}}{{"\n"}}{{end}}' | grep -E '10\.11\.[0-9]+\.[0-9]+' | sort -u)
# Loop from 1 to 254 to find an unused subnet
HARBOR_ID=1
for i in $(seq 1 254); do
    if ! echo "$USED_SUBNETS" | grep -q "10.11.$i."; then
        HARBOR_ID=$i
        break
    fi
done


if [ "$ACTION" == "up" ]; then

    # Check if harbor registry is running
    if ! docker inspect harbor-registry >/dev/null 2>&1; then
        echo "Staring harbor registry container..."
        # This is a docker registry that caches all harbor images for faster startup
        docker run -d --restart=always --name harbor-registry --hostname registry -v harbor-registry:/var/lib/registry registry:2
    fi


    echo "Starting Harbor replicas..."
    docker network rm harbor_net_${HARBOR_NAME} 2>/dev/null
    docker network create --subnet 10.11.${HARBOR_ID}.0/24 harbor-net-${HARBOR_NAME}

    docker network connect harbor-net-${HARBOR_NAME} harbor-registry


    last_id=""
    build_needed="true"
    for i in $(seq 1 $REPLICA_COUNT); do
      echo "Starting harbor-${HARBOR_NAME}-$i at 10.11.${HARBOR_ID}.$(($i + 2))"
      last_id=$(docker run --rm --privileged -dt --network harbor-net-${HARBOR_NAME} --ip 10.11.${HARBOR_ID}.$(($i + 2)) -e BUILD_HARBOR=${build_needed} -e HARBOR_HASH=${HARBOR_HASH} --name harbor-${HARBOR_NAME}-$i -v ${HARBOR_PATH}:/mount:ro harbor)
      if [ "$build_needed" == "false" ]; then
        continue
      fi
      docker logs -f $last_id | sed '/Docker containers created./{q}'
      build_needed="false"
    done

    docker logs -f $last_id | sed '/Attaching to /{q}'

    echo "Harbor up, replicas available:"
    for i in $(seq 1 $REPLICA_COUNT); do
      echo "  - 10.11.${HARBOR_ID}.$(($i + 2)) (harbor-${HARBOR_NAME}-$i)"
    done

elif [ "$ACTION" == "down" ]; then
    echo "Stopping Harbor replicas..."
    for i in $(seq 1 $REPLICA_COUNT); do
      docker rm -f harbor-${HARBOR_NAME}-$i 2>/dev/null
    done
    docker network disconnect harbor-net-${HARBOR_NAME} harbor-registry 2>/dev/null
    docker network rm harbor-net-${HARBOR_NAME} 2>/dev/null
fi
